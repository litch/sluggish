name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - v[0-9]+.*

      jobs:
        linux-x86_64:
          runs-on: ubuntu-latest
          steps:
            - uses: actions/checkout@v1
      
            - uses: actions-rs/toolchain@v1
              with:
                profile: minimal
                toolchain: stable
                default: true
      
            - name: Build binary
              uses: actions-rs/cargo@v1
              with:
                command: build
                args: --release --target x86_64-unknown-linux-musl
                use-cross: true
      
            - name: Optimize and package binary
              run: |
                cd target/x86_64-unknown-linux-musl/release
                strip naru
                chmod +x naru
                tar -c naru | gzip > naru.tar.gz
            - name: Upload binary
              uses: actions/upload-release-asset@v1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                asset_name: naru-${{ github.event.release.tag-name }}-linux-x86_64.tar.gz
                asset_path: target/x86_64-unknown-linux-musl/release/naru.tar.gz
                upload_url: ${{ github.event.release.upload_url }}